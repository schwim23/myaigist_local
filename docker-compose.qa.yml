version: '3.8'

services:
  ollama:
    image: ollama/ollama:latest
    container_name: myaigist-ollama-qa
    volumes:
      - ollama_models_qa:/root/.ollama
    ports:
      - "11435:11434"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/"]
      interval: 30s
      timeout: 10s
      retries: 3

  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    container_name: myaigist-whisper-qa
    environment:
      - ASR_MODEL=base
      - ASR_ENGINE=faster_whisper
    ports:
      - "9001:9000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  piper:
    image: lscr.io/linuxserver/piper:latest
    container_name: myaigist-piper-qa
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - PIPER_VOICE=en_US-lessac-medium
    ports:
      - "10201:10200"
    volumes:
      - piper_data_qa:/config
    restart: unless-stopped

  app:
    build: .
    container_name: myaigist-app-qa
    depends_on:
      - ollama
      - whisper
      - piper
    environment:
      - FLASK_ENV=qa
      - OLLAMA_HOST=http://ollama:11434
      - WHISPER_HOST=http://whisper:9000
      - PIPER_HOST=http://piper:10200
      - OLLAMA_MODEL=qwen2.5:14b
      - OLLAMA_EMBED_MODEL=nomic-embed-text
      - MAX_CONTENT_LENGTH=52428800
    ports:
      - "8001:8000"
    volumes:
      - ./data_qa:/app/data
      - ./uploads_qa:/app/uploads
      - ./static/audio:/app/static/audio
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  ollama_models_qa:
  piper_data_qa:
